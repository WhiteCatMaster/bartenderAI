<html>
{% load static %}
<head>
    <meta charset="utf-8">
    <title>The Bartender Robot - Leo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; overflow: hidden; position: relative; background: #000; }

        #bar-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            background-image: url('https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fi.pinimg.com%2Foriginals%2F2a%2Fab%2F99%2F2aab99efee25bc8b2798d71d8cc454a3.jpg&f=1&nofb=1');
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        #bar-background::after { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); }

        .main-container { position: relative; z-index: 2; width: 100%; height: 100vh; display:flex; justify-content:center; align-items:center; }

        /* Contenedor del bartender: escalado 400% (mÃ¡s seguro) */
        #bartender-container {
            position: relative;
            width: 400px; height: 600px;
            transform: scale(4);
            transform-origin: center center;
            display: flex; justify-content: center; align-items: center;
            max-width: 90vw; max-height: 90vh;
        }

        #bartender-image {
            width: 100%; height: 100%; object-fit: contain; transition: opacity 0.12s ease;
            filter: drop-shadow(0 20px 40px rgba(0,0,0,0.5)); display:block; margin:auto;
        }

        /* Clases para alternar boca (se usa className en JS) */
        .mouth-closed { /* si prefieres CSS-replace, pero tambiÃ©n trabajamos con src en JS */ }
        .mouth-open { }

        .control-panel {
            position: fixed; top: 20px; right: 20px; background: rgba(26,20,16,0.92);
            border: 2px solid rgba(212,175,55,0.4); border-radius: 20px; padding: 25px; width: 320px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6), inset 0 1px 0 rgba(212,175,55,0.2);
            backdrop-filter: blur(10px); z-index: 3; max-height: calc(100vh - 40px); overflow-y:auto;
        }

        .panel-title { font-size:20px; font-weight:700; color:#d4af37; margin-bottom:20px; text-align:center; }
        #start-voice { width:100%; padding:14px 20px; font-size:15px; font-weight:600; color:#1a1410;
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); border-radius:12px; cursor:pointer;
            margin-bottom:15px; border:2px solid rgba(212,175,55,0.6);
        }
        .output-box { background: rgba(42,35,28,0.8); border-left:4px solid #d4af37; padding:12px 15px; margin-bottom:12px; border-radius:10px; color:#e8d4b0; }
        .label { font-size:11px; font-weight:700; text-transform:uppercase; color:#d4af37; display:block; margin-bottom:5px; }
        #robot-status { background: rgba(42,35,28,0.9); border:2px solid #d4af37; color:#d4af37; padding:12px 15px; border-radius:10px; font-weight:600; text-align:center; margin-top:15px; }

        @media (max-width:768px) {
            .control-panel { position: fixed; bottom:0; right:0; left:0; top:auto; width:100%; border-radius:20px 20px 0 0; max-height:50vh; }
            #bartender-container { transform: scale(3); width:320px; height:480px; }
        }
        @media (max-width:480px) {
            #bartender-container { transform: scale(2.2); width:240px; height:360px; }
        }
    </style>
</head>
<body>
    <div id="bar-background"></div>

    <div class="top-header" style="position:fixed; top:20px; left:20px; z-index:3; background:rgba(26,20,16,0.92); padding:15px 25px; border-radius:15px; border:2px solid rgba(212,175,55,0.4);">
        <h1 style="color:#d4af37; font-size:22px; margin:0;">ðŸ¤– Bartender MegasXLR</h1>
    </div>

    <div class="main-container">
        <div id="bartender-container">
            <img id="bartender-image" class="mouth-closed" alt="Bartender Robot" src="{% static 'bartender_app/Images/barman1.png' %}">
        </div>
    </div>

    <div class="control-panel">
        <div class="panel-title">Control Panel</div>
        <button id="start-voice">ðŸŽ¤ Habilitar Escucha</button>

        <div class="output-box">
            <span class="label">TÃº dices:</span>
            <div id="user-output"></div>
        </div>

        <div class="output-box">
            <span class="label">Bartender dice:</span>
            <div id="bartender-output"></div>
        </div>

        <div id="robot-status">ðŸ”Œ Estado del Robot: Desconectado</div>
    </div>

    <script>
    // Rutas de imÃ¡genes (usar {% static %})
    const IMG_CLOSED = "{% static 'bartender_app/Images/barman1.png' %}";
    const IMG_OPEN = "{% static 'bartender_app/Images/barman2.png' %}";
    const IMG_WORKING = "{% static 'bartender_app/Images/barman_working.png' %}";

    const startVoiceButton = document.getElementById('start-voice');
    const userOutput = document.getElementById('user-output');
    const bartenderOutput = document.getElementById('bartender-output');
    const bartenderImage = document.getElementById('bartender-image');
    const statusOutput = document.getElementById('robot-status');

    let isListening = false;
    let mouthInterval = null;
    let workingTimer = null;
    let prevSrc = null;
    let prevClass = null;
    const synth = window.speechSynthesis;
    let ttsVoice = null;

    // Asegurar src inicial
    bartenderImage.src = bartenderImage.src || IMG_CLOSED;

    function loadVoices() {
        const voices = synth.getVoices();
        ttsVoice = voices.find(v => v.lang === 'en-US') || voices.find(v => v.lang && v.lang.startsWith('en')) || voices[0] || null;
    }
    if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices;
    loadVoices();

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'es-ES';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = (event) => {
        isListening = false;
        recognition.stop();
        const speechResult = event.results[0][0].transcript;
        userOutput.textContent = speechResult;
        sendToDjango(speechResult);
    };

    recognition.onend = () => {
        if (isListening) recognition.start();
        else startVoiceButton.innerHTML = "ðŸŽ¤ Escucha Detenida (Clic para REINICIAR)";
    };

    recognition.onerror = (e) => {
        console.error('Recognition error', e);
        if (isListening) setTimeout(() => recognition.start(), 1000);
    };

    startVoiceButton.addEventListener('click', () => {
        if (synth.speaking) { synth.cancel(); stopSpeakingAnimation(); }
        if (isListening) { isListening = false; recognition.stop(); }
        else startContinuousListening();
    });

    function startContinuousListening() {
        if (isListening) return;
        isListening = true;
        recognition.start();
        startVoiceButton.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:#52c41a;border-radius:50%;margin-right:6px;"></span>Escuchando... (Clic para DETENER)';
        userOutput.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:#52c41a;border-radius:50%;margin-right:6px;"></span>Escuchando continuamente...';
    }

    async function sendToDjango(message) {
        bartenderOutput.textContent = 'â³ Procesando la orden...';
        try {
            const res = await fetch('/api/dialogue/', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ message })
            });
            if (!res.ok) throw new Error('Status ' + res.status);
            const data = await res.json();
            handleBartenderResponse(data.response || '');
        } catch (err) {
            console.error('Error API:', err);
            bartenderOutput.textContent = 'âš ï¸ Vaya, parece que hay un problema de conexiÃ³n.';
            setTimeout(() => startContinuousListening(), 500);
        }
    }

    function startSpeakingAnimation() {
        clearInterval(mouthInterval);
        mouthInterval = setInterval(() => {
            bartenderImage.className = (Math.random() > 0.5) ? 'mouth-open' : 'mouth-closed';
            // Alternativamente actualizar src si prefieres:
            // bartenderImage.src = (Math.random() > 0.5) ? IMG_OPEN : IMG_CLOSED;
        }, 150);
    }
    function stopSpeakingAnimation() {
        clearInterval(mouthInterval);
        mouthInterval = null;
        bartenderImage.className = 'mouth-closed';
        // bartenderImage.src = IMG_CLOSED;
    }

    function handleBartenderResponse(responseText) {
        bartenderOutput.textContent = responseText;
        if (synth.speaking) synth.cancel();

        const utterance = new SpeechSynthesisUtterance(responseText || '');
        utterance.lang = 'en-US';
        if (ttsVoice) utterance.voice = ttsVoice;
        utterance.rate = 1.0;

        utterance.onstart = () => startSpeakingAnimation();
        utterance.onend = () => { stopSpeakingAnimation(); setTimeout(() => startContinuousListening(), 200); };
        utterance.onerror = () => { stopSpeakingAnimation(); setTimeout(() => startContinuousListening(), 200); };

        synth.speak(utterance);
    }

    // Muestra imagen temporal "working" y restaura anterior
    function showTemporaryImage(durationSeconds = 60) {
        if (workingTimer) {
            clearTimeout(workingTimer);
            workingTimer = null;
        }
        prevSrc = bartenderImage.src;
        prevClass = bartenderImage.className;
        if (mouthInterval) { clearInterval(mouthInterval); mouthInterval = null; }

        // Forzar imagen working (quitar clases para que src sea visible en todos los navegadores)
        bartenderImage.className = '';
        bartenderImage.src = IMG_WORKING;

        workingTimer = setTimeout(() => {
            // Restaurar clase y/o src previa
            if (prevClass) bartenderImage.className = prevClass;
            bartenderImage.src = prevSrc || IMG_CLOSED;
            workingTimer = null;
        }, durationSeconds * 1000);
    }

    // WebSocket
    function connectWebSocket() {
        const SERVER_IP = '10.194.222.20';
        const SERVER_PORT = '8080';
        const protocol = 'ws:'; // o 'wss:' si corresponde
        const websocket_url = protocol + '//' + SERVER_IP + ':' + SERVER_PORT + '/ws/robot/';
        const robotSocket = new WebSocket(websocket_url);

        robotSocket.onopen = () => { statusOutput.textContent = 'âœ… Estado del Robot: Conectado. Esperando orden...'; };

        robotSocket.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);
                if (data.type === 'command') {
                    const command = data.command;
                    statusOutput.textContent = `ðŸŽ¯ Estado del Robot: Recibida la orden: ${command}`;
                    // Mostrar imagen "working" por 60 segundos al recibir comando
                    showTemporaryImage(60);
                    if (command.startsWith("PREPARAR")) {
                        statusOutput.textContent += ' - Â¡Iniciando mezcla! ðŸ¹';
                    }
                }
            } catch (err) {
                console.error('WS message parse error', err);
            }
        };

        robotSocket.onclose = (e) => {
            statusOutput.textContent = 'ðŸ”„ Estado del Robot: Desconectado. Intentando reconectar...';
            if (e.code !== 1000) setTimeout(connectWebSocket, 3000);
        };
        robotSocket.onerror = (e) => console.error('WebSocket Error:', e);
    }

    // Inicio
    connectWebSocket();
    startContinuousListening();
    </script>
</body>
</html>
